name: Reusable Deployment Workflow

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: string
      force_deploy:
        description: 'Force deployment (skip checks)'
        required: false
        default: false
        type: boolean
      skip_backup:
        description: 'Skip backup creation'
        required: false
        default: false
        type: boolean
      ref:
        description: 'Git ref to deploy'
        required: false
        default: ''
        type: string
    secrets:
      DEPLOY_HOST:
        required: true
      DEPLOY_USER:
        required: true
      DEPLOY_PATH:
        required: true
      DEPLOY_SSH_KEY:
        required: true
      DEPLOY_PORT:
        required: false
      BACKUP_PATH:
        required: false
      HEALTH_CHECK_URL:
        required: false
      SLACK_WEBHOOK_URL:
        required: false
      SMTP_SERVER:
        required: false
      SMTP_PORT:
        required: false
      SMTP_USERNAME:
        required: false
      SMTP_PASSWORD:
        required: false
      NOTIFICATION_EMAIL:
        required: false

env:
  PHP_VERSION: '8.4.10'
  PLUGIN_NAME: '84em-local-pages'
  SITE_URL: ${{ inputs.environment == 'production' && 'https://84em.com' || inputs.environment == 'dev' && 'https://dev.84em.com' || 'https://staging.84em.com' }}
  SSH_PORT: ${{ secrets.DEPLOY_PORT || 22 }}

jobs:
  # Pre-deployment validation
  validate:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest

    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      backup_name: ${{ steps.backup.outputs.backup_name }}
      deploy_hash: ${{ steps.hash.outputs.deploy_hash }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref || github.ref }}
        fetch-depth: 2

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, intl, openssl, curl
        tools: composer:v2

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: vendor
        key: composer-${{ hashFiles('composer.lock') }}
        restore-keys: composer-

    - name: Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader --no-progress

    - name: PHP Syntax Check
      run: |
        echo "::group::Checking PHP syntax"
        error_count=0
        while IFS= read -r -d '' file; do
          output=$(php -l "$file" 2>&1)
          if [[ $? -ne 0 ]]; then
            echo "❌ Syntax error in $file:"
            echo "$output"
            error_count=$((error_count + 1))
          fi
        done < <(find . -name "*.php" -not -path "./vendor/*" -print0)
        
        if [[ $error_count -gt 0 ]]; then
          echo "❌ Found $error_count file(s) with syntax errors"
          exit 1
        fi
        echo "✅ All PHP files have valid syntax"
        echo "::endgroup::"

    - name: Validate composer.json
      if: inputs.environment == 'production'
      run: |
        echo "::group::Validating Composer configuration"
        composer validate --no-check-all --no-check-publish
        echo "✅ composer.json is valid"
        echo "::endgroup::"

    - name: Check for required files
      run: |
        echo "::group::Checking required files"
        required_files=(
          "84em-local-pages.php"
          "composer.json"
        )
        
        for file in "${required_files[@]}"; do
          if [[ ! -e "$file" ]]; then
            echo "❌ Required file/directory missing: $file"
            exit 1
          fi
          echo "✅ Found: $file"
        done
        echo "::endgroup::"

    - name: Generate deployment hash
      id: hash
      run: |
        deploy_hash=$(find . -name "*.php" -not -path "./vendor/*" -not -path "./tests/*" -exec sha256sum {} + | sha256sum | cut -d' ' -f1)
        echo "deploy_hash=$deploy_hash" >> $GITHUB_OUTPUT
        echo "Generated deployment hash: $deploy_hash"

    - name: Generate backup name
      id: backup
      run: |
        backup_name="84em-local-pages-backup-${{ inputs.environment }}-$(date +%Y%m%d-%H%M%S)-${{ github.sha }}"
        echo "backup_name=$backup_name" >> $GITHUB_OUTPUT
        echo "Generated backup name: $backup_name"

    - name: Deployment decision
      id: check
      run: |
        should_deploy="true"
        
        # Skip deployment checks if force deploy is enabled
        if [[ "${{ inputs.force_deploy }}" == "true" ]]; then
          echo "⚠️ Force deployment enabled, skipping additional checks"
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # For dev environment, allow deployment from dev or main branch
        if [[ "${{ inputs.environment }}" == "dev" ]]; then
          if [[ "${{ github.ref_name }}" == "dev" ]] || [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "✅ Dev deployment from ${{ github.ref_name }} branch"
          else
            echo "⚠️ Dev deployment typically from dev or main branch"
            echo "Current ref: ${{ github.ref_name }}"
          fi
        fi
        
        # For production, require main branch
        if [[ "${{ inputs.environment }}" == "production" ]]; then
          if [[ "${{ github.ref_name }}" != "main" ]]; then
            echo "❌ Production deployment only allowed from main branch"
            echo "Current ref: ${{ github.ref_name }}"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        fi
        
        echo "should_deploy=$should_deploy" >> $GITHUB_OUTPUT
        echo "✅ Pre-deployment validation passed for ${{ inputs.environment }}"

  # Create backup of current deployment
  backup:
    name: Backup Current ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: validate
    if: |
      needs.validate.result == 'success' && 
      needs.validate.outputs.should_deploy == 'true' && 
      !inputs.skip_backup &&
      (inputs.environment == 'production' || inputs.environment == 'staging')

    steps:
    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

    - name: Add known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H -p ${{ env.SSH_PORT }} ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

    - name: Test SSH connection
      run: |
        echo "::group::Testing SSH connection"
        ssh -p ${{ env.SSH_PORT }} -o ConnectTimeout=10 ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "echo 'SSH connection successful'"
        echo "::endgroup::"

    - name: Create backup
      run: |
        echo "::group::Creating backup for ${{ inputs.environment }}"
        
        BACKUP_PATH="${{ secrets.BACKUP_PATH }}"
        if [[ -z "$BACKUP_PATH" ]]; then
          echo "ℹ️ Backup path not configured for ${{ inputs.environment }}, skipping backup"
          exit 0
        fi
        
        ssh -p ${{ env.SSH_PORT }} ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} bash -s -- \
          "${{ secrets.DEPLOY_PATH }}" \
          "$BACKUP_PATH" \
          "${{ needs.validate.outputs.backup_name }}" <<'BACKUP_EOF'
          set -e
          DEPLOY_PATH="$1"
          BACKUP_PATH="$2"
          BACKUP_NAME="$3"
          
          mkdir -p "${BACKUP_PATH}"

          if [[ -d "${DEPLOY_PATH}" ]]; then
            echo "Creating backup: ${BACKUP_NAME}"
            cp -r "${DEPLOY_PATH}" "${BACKUP_PATH}/${BACKUP_NAME}"
            echo "Backup created successfully"
            
            # Keep only last 10 backups for this environment
            (
              flock -x 200
              cd "${BACKUP_PATH}"
              ls -t | grep -E "^84em-local-pages-backup-${{ inputs.environment }}-" | tail -n +11 | xargs -r rm -rf
              echo "Old backups cleaned up"
            ) 200>/tmp/backup_cleanup.lock
          else
            echo "No existing installation found, skipping backup"
          fi
        BACKUP_EOF
        
        echo "::endgroup::"

    - name: Backup verification
      run: |
        BACKUP_PATH="${{ secrets.BACKUP_PATH }}"
        if [[ -z "$BACKUP_PATH" ]]; then
          exit 0
        fi
        
        backup_size=$(ssh -p ${{ env.SSH_PORT }} ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} bash -s -- \
          "$BACKUP_PATH" \
          "${{ needs.validate.outputs.backup_name }}" <<'VERIFY_EOF'
          BACKUP_PATH="$1"
          BACKUP_NAME="$2"
          if [[ -d "${BACKUP_PATH}/${BACKUP_NAME}" ]]; then
            du -sh "${BACKUP_PATH}/${BACKUP_NAME}" | cut -f1
          else
            echo '0'
          fi
        VERIFY_EOF
        )
        
        if [[ "$backup_size" != "0" ]]; then
          echo "✅ Backup verified: $backup_size"
        else
          echo "ℹ️ No backup created (fresh installation)"
        fi

  # Deploy to target environment
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: [validate, backup]
    if: |
      needs.validate.result == 'success' && 
      needs.validate.outputs.should_deploy == 'true' && 
      (needs.backup.result == 'success' || needs.backup.result == 'skipped')

    environment:
      name: ${{ inputs.environment }}
      url: ${{ env.SITE_URL }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.ref || github.ref }}

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, intl, openssl, curl
        tools: composer:v2

    - name: Install production dependencies
      run: |
        echo "::group::Installing production dependencies"
        composer install --no-dev --optimize-autoloader --no-progress
        echo "::endgroup::"

    - name: Prepare deployment files
      run: |
        echo "::group::Preparing files for ${{ inputs.environment }} deployment"
        
        # Remove development and CI files
        rm -f deploy.sh
        rm -rf .git
        rm -rf .github
        rm -rf tests
        rm -rf node_modules
        rm -f .gitignore
        rm -f .gitattributes
        rm -f phpunit.xml
        rm -f phpcs.xml
        
        # Keep documentation for dev, remove for production
        if [[ "${{ inputs.environment }}" == "production" ]]; then
          rm -f README.md
          rm -f TESTING.md
          rm -f CLAUDE.md
        fi
        
        # Create deployment manifest
        echo "Deployment Info:" > DEPLOYMENT_INFO.txt
        echo "- Environment: ${{ inputs.environment }}" >> DEPLOYMENT_INFO.txt
        echo "- Commit: ${{ github.sha }}" >> DEPLOYMENT_INFO.txt
        echo "- Branch: ${{ github.ref_name }}" >> DEPLOYMENT_INFO.txt
        echo "- Deployed at: $(date -u)" >> DEPLOYMENT_INFO.txt
        echo "- Deployed by: GitHub Actions" >> DEPLOYMENT_INFO.txt
        echo "- Deploy Hash: ${{ needs.validate.outputs.deploy_hash }}" >> DEPLOYMENT_INFO.txt
        echo "- Workflow Run: ${{ github.run_id }}" >> DEPLOYMENT_INFO.txt
        
        echo "Files prepared for deployment"
        echo "::endgroup::"

    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

    - name: Add known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H -p ${{ env.SSH_PORT }} ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy files via rsync
      run: |
        echo "::group::Deploying files to ${{ inputs.environment }}"
        
        # Additional excludes for dev environment
        EXTRA_EXCLUDES=""
        if [[ "${{ inputs.environment }}" != "dev" ]]; then
          EXTRA_EXCLUDES="--exclude='*.md'"
        fi
        
        rsync -avz \
          --delete \
          --exclude='deploy.sh' \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='.github' \
          --exclude='tests' \
          $EXTRA_EXCLUDES \
          --progress \
          --stats \
          -e "ssh -p ${{ env.SSH_PORT }}" \
          ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/
        
        echo "✅ Files deployed successfully to ${{ inputs.environment }}"
        echo "::endgroup::"

    - name: Set proper file permissions
      run: |
        echo "::group::Setting file permissions"
        
        ssh -p ${{ env.SSH_PORT }} ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} bash -s -- \
          "${{ secrets.DEPLOY_PATH }}" \
          "${{ env.PLUGIN_NAME }}" <<'PERMS_EOF'
          set -e
          DEPLOY_PATH="$1"
          PLUGIN_NAME="$2"
          cd "${DEPLOY_PATH}"
          
          # Set directory permissions (755)
          find . -type d -exec chmod 755 {} +
          
          # Set file permissions (644 for most files, 640 for sensitive files)
          find . -type f -exec chmod 644 {} +
          
          # More restrictive permissions for sensitive files
          find . -name 'composer.json' -exec chmod 640 {} +
          find . -name 'composer.lock' -exec chmod 640 {} +
          find . -name '*.php' -path './config/*' -exec chmod 640 {} +
          
          # Make sure the main plugin file is readable
          chmod 644 "${PLUGIN_NAME}.php"
          
          echo 'File permissions set correctly'
        PERMS_EOF
        
        echo "::endgroup::"

  # Post-deployment verification
  verify:
    name: Post-deployment Verification
    runs-on: ubuntu-latest
    needs: [validate, backup, deploy]
    if: |
      needs.validate.result == 'success' && 
      needs.deploy.result == 'success' && 
      needs.validate.outputs.should_deploy == 'true'

    steps:
    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

    - name: Add known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H -p ${{ env.SSH_PORT }} ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

    - name: Verify deployment
      run: |
        echo "::group::Verifying ${{ inputs.environment }} deployment"
        
        ssh -p ${{ env.SSH_PORT }} ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} bash -s -- \
          "${{ secrets.DEPLOY_PATH }}" \
          "${{ env.PLUGIN_NAME }}" <<'VERIFY_DEPLOY_EOF'
          set -e
          DEPLOY_PATH="$1"
          PLUGIN_NAME="$2"
          
          if [[ -f "${DEPLOY_PATH}/${PLUGIN_NAME}.php" ]]; then
            echo '✅ Main plugin file exists'
          else
            echo '❌ Main plugin file missing'
            exit 1
          fi
          
          # Check directory structure
          required_dirs=('vendor')
          for dir in "${required_dirs[@]}"; do
            if [[ -d "${DEPLOY_PATH}/${dir}" ]]; then
              echo "✅ Directory exists: ${dir}"
            else
              echo "❌ Directory missing: ${dir}"
              exit 1
            fi
          done
          
          # Check optional directories
          optional_dirs=('tests' 'config' 'src')
          for dir in "${optional_dirs[@]}"; do
            if [[ -d "${DEPLOY_PATH}/${dir}" ]]; then
              echo "✅ Optional directory exists: ${dir}"
            else
              echo "ℹ️ Optional directory not present: ${dir}"
            fi
          done
          
          # Check PHP syntax on server
          php -l "${DEPLOY_PATH}/${PLUGIN_NAME}.php" || exit 1
          echo '✅ PHP syntax check passed on server'
          
          # Check file sizes (basic integrity check)
          main_size=$(stat -c%s "${DEPLOY_PATH}/${PLUGIN_NAME}.php")
          if [[ ${main_size} -lt 1000 ]]; then
            echo '❌ Main plugin file seems too small'
            exit 1
          fi
          echo "✅ Main plugin file size: ${main_size} bytes"
          
          # Verify deployment hash if available
          if [[ -f "${DEPLOY_PATH}/DEPLOYMENT_INFO.txt" ]]; then
            echo '✅ Deployment info file found'
            cat "${DEPLOY_PATH}/DEPLOYMENT_INFO.txt"
          fi
        VERIFY_DEPLOY_EOF
        
        echo "::endgroup::"

    - name: Test basic plugin functionality
      run: |
        echo "::group::Testing basic functionality"
        
        ssh -p ${{ env.SSH_PORT }} ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} bash -s -- \
          "${{ secrets.DEPLOY_PATH }}" \
          "${{ env.PLUGIN_NAME }}" <<'LOAD_TEST_EOF'
          set -e
          DEPLOY_PATH="$1"
          PLUGIN_NAME="$2"
          cd "${DEPLOY_PATH}"
          php -r "include '${PLUGIN_NAME}.php'; echo 'Plugin loaded successfully\n';" || {
            echo '❌ Plugin failed to load'
            exit 1
          }
          echo '✅ Plugin loads without errors'
        LOAD_TEST_EOF
        
        echo "::endgroup::"

    - name: Health check endpoint test
      if: inputs.environment == 'production'
      run: |
        echo "::group::Testing health check endpoint"
        
        HEALTH_CHECK_URL="${{ secrets.HEALTH_CHECK_URL }}"
        
        if [[ -z "$HEALTH_CHECK_URL" ]]; then
          echo "ℹ️ Health check URL not configured, skipping"
          echo "::endgroup::"
          exit 0
        fi
        
        # Wait a moment for changes to propagate
        sleep 10
        
        response=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_CHECK_URL" || echo "000")
        
        if [[ "$response" == "200" ]]; then
          echo "✅ Health check passed (HTTP $response)"
        else
          echo "❌ Health check failed (HTTP $response)"
          echo "::error::Health check failed with HTTP $response. Deployment will be rolled back."
          exit 1
        fi
        
        echo "::endgroup::"

  # Rollback job (only runs on failure for production/staging)
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [validate, backup, deploy, verify]
    if: |
      failure() && 
      needs.backup.result == 'success' && 
      !inputs.skip_backup &&
      (inputs.environment == 'production' || inputs.environment == 'staging')

    steps:
    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

    - name: Add known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H -p ${{ env.SSH_PORT }} ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

    - name: Rollback to previous version
      run: |
        echo "::group::Rolling back ${{ inputs.environment }} deployment"
        
        ssh -p ${{ env.SSH_PORT }} ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} bash -s -- \
          "${{ secrets.DEPLOY_PATH }}" \
          "${{ secrets.BACKUP_PATH }}" \
          "${{ needs.validate.outputs.backup_name }}" \
          "${{ github.sha }}" <<'ROLLBACK_EOF'
          set -e
          DEPLOY_PATH="$1"
          BACKUP_PATH="$2"
          BACKUP_NAME="$3"
          GITHUB_SHA="$4"
          backup_path="${BACKUP_PATH}/${BACKUP_NAME}"
          
          if [[ -d "${backup_path}" ]]; then
            echo "Rolling back to backup: ${BACKUP_NAME}"
            
            # Remove failed deployment
            rm -rf "${DEPLOY_PATH}"
            
            # Restore from backup
            cp -r "${backup_path}" "${DEPLOY_PATH}"
            
            # Add rollback marker
            {
              echo 'ROLLBACK PERFORMED'
              echo "Original commit: ${GITHUB_SHA}"
              echo "Rollback time: $(date -u)"
            } >> "${DEPLOY_PATH}/ROLLBACK_INFO.txt"
            
            echo '✅ Rollback completed successfully'
          else
            echo '⚠️ No backup found, manual intervention required'
            exit 1
          fi
        ROLLBACK_EOF
        
        echo "::endgroup::"

    - name: Verify rollback
      run: |
        ssh -p ${{ env.SSH_PORT }} ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} bash -s -- \
          "${{ secrets.DEPLOY_PATH }}" \
          "${{ env.PLUGIN_NAME }}" <<'VERIFY_ROLLBACK_EOF'
          set -e
          DEPLOY_PATH="$1"
          PLUGIN_NAME="$2"
          if [[ -f "${DEPLOY_PATH}/${PLUGIN_NAME}.php" ]]; then
            echo "✅ Main plugin file exists after rollback"
            php -l "${DEPLOY_PATH}/${PLUGIN_NAME}.php" || exit 1
            echo "✅ PHP syntax check passed after rollback"
            
            if [[ -d "${DEPLOY_PATH}/vendor" ]]; then
              echo "✅ Vendor directory restored"
            fi
            
            echo "✅ Rollback verification completed successfully"
          else
            echo "❌ Rollback verification failed - main plugin file missing"
            exit 1
          fi
        VERIFY_ROLLBACK_EOF

  # Notification job
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [validate, backup, deploy, verify, rollback]
    if: always() && needs.validate.outputs.should_deploy == 'true'

    steps:
    - name: Determine deployment status
      id: status
      run: |
        if [[ "${{ needs.verify.result }}" == "success" ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=✅ ${{ inputs.environment }} deployment completed successfully" >> $GITHUB_OUTPUT
          echo "color=good" >> $GITHUB_OUTPUT
        elif [[ "${{ needs.rollback.result }}" == "success" ]]; then
          echo "status=rolled_back" >> $GITHUB_OUTPUT
          echo "message=⚠️ ${{ inputs.environment }} deployment failed and was rolled back" >> $GITHUB_OUTPUT
          echo "color=warning" >> $GITHUB_OUTPUT
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "message=❌ ${{ inputs.environment }} deployment failed" >> $GITHUB_OUTPUT
          echo "color=danger" >> $GITHUB_OUTPUT
        fi

    - name: Send Slack notification
      if: always() && (inputs.environment == 'production' || (inputs.environment != 'production' && needs.verify.result != 'success'))
      continue-on-error: true
      uses: 8398a7/action-slack@v3
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      with:
        status: custom
        custom_payload: |
          {
            "text": "${{ steps.status.outputs.message }}",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*84em Local Pages Plugin Deployment*\n${{ steps.status.outputs.message }}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\n${{ inputs.environment }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Commit:*\n<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n${{ github.ref_name }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Triggered by:*\n${{ github.actor }}"
                  }
                ]
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Workflow"
                    },
                    "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }

    - name: Send email notification
      if: steps.status.outputs.status != 'success' && inputs.environment == 'production'
      continue-on-error: true
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT || 587 }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "84em Local Pages ${{ inputs.environment }} Deployment ${{ steps.status.outputs.status }}"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: "GitHub Actions <noreply@github.com>"
        body: |
          Deployment Status: ${{ steps.status.outputs.message }}
          
          Environment: ${{ inputs.environment }}
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Triggered by: ${{ github.actor }}
          
          View full workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    - name: Create deployment summary
      run: |
        echo "## 🚀 Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Status | ${{ steps.status.outputs.message }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Deploy Hash | \`${{ needs.validate.outputs.deploy_hash }}\` |" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ needs.backup.result }}" == "success" ]]; then
          echo "| Backup created | ${{ needs.validate.outputs.backup_name }} |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Target path:** \`${{ secrets.DEPLOY_PATH }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Backup path:** \`${{ secrets.BACKUP_PATH || 'Not configured' }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **SSH Port:** ${{ env.SSH_PORT }}" >> $GITHUB_STEP_SUMMARY
        echo "- **PHP version:** ${{ env.PHP_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Site URL:** ${{ env.SITE_URL }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Job Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Validation:** ${{ needs.validate.result }} ✅" >> $GITHUB_STEP_SUMMARY
        echo "- **Backup:** ${{ needs.backup.result || 'skipped' }} ${{ needs.backup.result == 'success' && '✅' || needs.backup.result == 'failure' && '❌' || '⏭️' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deploy:** ${{ needs.deploy.result }} ${{ needs.deploy.result == 'success' && '✅' || '❌' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Verify:** ${{ needs.verify.result }} ${{ needs.verify.result == 'success' && '✅' || '❌' }}" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ needs.rollback.result }}" != "" ]]; then
          echo "- **Rollback:** ${{ needs.rollback.result }} ${{ needs.rollback.result == 'success' && '✅' || '❌' }}" >> $GITHUB_STEP_SUMMARY
        fi
