name: Deploy to Production

on:
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]
  # Remove pull_request trigger if it exists
  # pull_request trigger should NEVER deploy
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      force_deploy:
        description: 'Force deployment (skip checks)'
        required: false
        default: false
        type: boolean
      skip_backup:
        description: 'Skip backup creation (use with caution)'
        required: false
        default: false
        type: boolean

env:
  PHP_VERSION: '8.2'
  PLUGIN_NAME: '84em-local-pages'
  SITE_URL: 'https://84em.com'
  DEPLOY_PATH: '${{ secrets.DEPLOY_PATH }}'
  BACKUP_PATH: '${{ secrets.BACKUP_PATH }}'
  SSH_PORT: '${{ secrets.DEPLOY_PORT }}'

jobs:
  # Pre-deployment validation
  validate:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest

    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      backup_name: ${{ steps.backup.outputs.backup_name }}
      deploy_hash: ${{ steps.hash.outputs.deploy_hash }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, intl, openssl, curl
        tools: composer:v2

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: vendor
        key: composer-${{ hashFiles('composer.lock') }}
        restore-keys: composer-

    - name: Install Composer dependencies
      run: composer install --no-dev --optimize-autoloader --no-progress --no-suggest

    - name: PHP Syntax Check
      run: |
        echo "::group::Checking PHP syntax"
        find . -name "*.php" -not -path "./vendor/*" -not -path "./tests/*" -exec php -l {} + || exit 1
        echo "‚úÖ All PHP files have valid syntax"
        echo "::endgroup::"

    - name: Validate composer.json
      run: |
        echo "::group::Validating Composer configuration"
        composer validate --no-check-all --no-check-publish
        echo "‚úÖ composer.json is valid"
        echo "::endgroup::"

    - name: Check for required files
      run: |
        echo "::group::Checking required files"
        required_files=(
          "84em-local-pages.php"
          "composer.json"
        )
        
        for file in "${required_files[@]}"; do
          if [[ ! -e "$file" ]]; then
            echo "‚ùå Required file/directory missing: $file"
            exit 1
          fi
          echo "‚úÖ Found: $file"
        done
        echo "::endgroup::"

    - name: Generate deployment hash
      id: hash
      run: |
        deploy_hash=$(find . -name "*.php" -not -path "./vendor/*" -not -path "./tests/*" -exec sha256sum {} + | sha256sum | cut -d' ' -f1)
        echo "deploy_hash=$deploy_hash" >> $GITHUB_OUTPUT
        echo "Generated deployment hash: $deploy_hash"

    - name: Generate backup name
      id: backup
      run: |
        backup_name="84em-local-pages-backup-$(date +%Y%m%d-%H%M%S)-${{ github.sha }}"
        echo "backup_name=$backup_name" >> $GITHUB_OUTPUT
        echo "Generated backup name: $backup_name"

    - name: Deployment decision
      id: check
      run: |
        should_deploy="true"
        
        # CRITICAL: Never deploy on pull requests
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "‚ùå BLOCKED: Deployments are not allowed from pull requests"
          echo "should_deploy=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Skip deployment checks if force deploy is enabled
        if [[ "${{ github.event.inputs.force_deploy }}" == "true" ]]; then
          echo "‚ö†Ô∏è Force deployment enabled, skipping additional checks"
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Check if this is a tag-based deployment
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "‚úÖ Tag-based deployment detected"
        elif [[ "${{ github.ref_name }}" == "main" ]]; then
          echo "‚úÖ Main branch deployment"
        else
          echo "‚ùå Deployment only allowed from main branch or tags"
          echo "Current ref: ${{ github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          echo "should_deploy=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "should_deploy=$should_deploy" >> $GITHUB_OUTPUT
        echo "‚úÖ Pre-deployment validation passed"

  # Create backup of current production
  backup:
    name: Backup Current Production
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_deploy == 'true' && github.event.inputs.skip_backup != 'true'

    steps:
    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

    - name: Add known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H -p ${{ env.SSH_PORT }} ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

    - name: Test SSH connection
      run: |
        echo "::group::Testing SSH connection"
        ssh -p ${{ env.SSH_PORT }} -o ConnectTimeout=10 ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "echo 'SSH connection successful'"
        echo "::endgroup::"

    - name: Create production backup
      run: |
        echo "::group::Creating backup"
        
        # Create backup directory if it doesn't exist and perform backup
        export DEPLOY_USER="${{ secrets.DEPLOY_USER }}"
        export DEPLOY_HOST="${{ secrets.DEPLOY_HOST }}"
        export SSH_PORT="${{ env.SSH_PORT }}"
        export DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
        export BACKUP_PATH="${{ env.BACKUP_PATH }}"
        export BACKUP_NAME="${{ needs.validate.outputs.backup_name }}"
        
        ssh -p "${SSH_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" 'bash -s' << 'EOF'
          set -e
          mkdir -p "${BACKUP_PATH}"

          if [[ -d "${DEPLOY_PATH}" ]]; then
            echo "Creating backup: ${BACKUP_NAME}"
            cp -r "${DEPLOY_PATH}" "${BACKUP_PATH}/${BACKUP_NAME}"
            echo "Backup created successfully"
            
            # Keep only last 10 backups (with locking to prevent race conditions)
            (
              flock -x 200
              cd "${BACKUP_PATH}"
              ls -t | grep -E '^84em-local-pages-backup-' | tail -n +11 | xargs -r rm -rf
              echo "Old backups cleaned up"
            ) 200>/tmp/backup_cleanup.lock
          else
            echo "No existing installation found, skipping backup"
          fi
EOF
        
        echo "::endgroup::"

    - name: Backup verification
      run: |
        export DEPLOY_USER="${{ secrets.DEPLOY_USER }}"
        export DEPLOY_HOST="${{ secrets.DEPLOY_HOST }}"
        export SSH_PORT="${{ env.SSH_PORT }}"
        backup_size=$(ssh -p "${SSH_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" 'bash -s' << 'EOF'
          if [[ -d "${BACKUP_PATH}/${BACKUP_NAME}" ]]; then
            du -sh "${BACKUP_PATH}/${BACKUP_NAME}" | cut -f1
          else
            echo '0'
          fi
EOF
        )
        
        if [[ "$backup_size" != "0" ]]; then
          echo "‚úÖ Backup verified: $backup_size"
        else
          echo "‚ÑπÔ∏è No backup created (fresh installation)"
        fi

  # Deploy to production
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [validate, backup]
    if: needs.validate.outputs.should_deploy == 'true' && (needs.backup.result == 'success' || needs.backup.result == 'skipped')

    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ env.SITE_URL }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        extensions: mbstring, intl, openssl, curl
        tools: composer:v2

    - name: Install production dependencies
      run: |
        echo "::group::Installing production dependencies"
        composer install --no-dev --optimize-autoloader --no-progress --no-suggest
        echo "::endgroup::"

    - name: Prepare deployment files
      run: |
        echo "::group::Preparing files for deployment"
        
        # Remove development and CI files
        rm -f deploy.sh
        rm -rf .git
        rm -rf .github
        rm -rf tests
        rm -rf node_modules
        rm -f .gitignore
        rm -f .gitattributes
        rm -f phpunit.xml
        rm -f phpcs.xml
        rm -f README.md
        rm -f TESTING.md
        rm -f Claude.md
        
        # Create deployment manifest
        echo "Deployment Info:" > DEPLOYMENT_INFO.txt
        echo "- Commit: ${{ github.sha }}" >> DEPLOYMENT_INFO.txt
        echo "- Branch: ${{ github.ref_name }}" >> DEPLOYMENT_INFO.txt
        echo "- Deployed at: $(date -u)" >> DEPLOYMENT_INFO.txt
        echo "- Deployed by: GitHub Actions" >> DEPLOYMENT_INFO.txt
        echo "- Deploy Hash: ${{ needs.validate.outputs.deploy_hash }}" >> DEPLOYMENT_INFO.txt
        echo "- Workflow Run: ${{ github.run_id }}" >> DEPLOYMENT_INFO.txt
        
        echo "Files prepared for deployment"
        echo "::endgroup::"

    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

    - name: Add known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H -p ${{ env.SSH_PORT }} ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy files via rsync
      run: |
        echo "::group::Deploying files"
        
        # Deploy with rsync (equivalent to original deploy.sh)
        rsync -avz \
          --delete \
          --exclude='deploy.sh' \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='.github' \
          --exclude='tests' \
          --exclude='*.md' \
          --progress \
          --stats \
          -e "ssh -p ${{ env.SSH_PORT }}" \
          ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ env.DEPLOY_PATH }}/
        
        echo "‚úÖ Files deployed successfully"
        echo "::endgroup::"

    - name: Set proper file permissions
      run: |
        echo "::group::Setting file permissions"
        
        export DEPLOY_USER="${{ secrets.DEPLOY_USER }}"
        export DEPLOY_HOST="${{ secrets.DEPLOY_HOST }}"
        export SSH_PORT="${{ env.SSH_PORT }}"
        export DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
        export PLUGIN_NAME="${{ env.PLUGIN_NAME }}"
        
        ssh -p "${SSH_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" 'bash -s' << 'EOF'
          set -e
          cd "${DEPLOY_PATH}"
          
          # Set directory permissions (755)
          find . -type d -exec chmod 755 {} +
          
          # Set file permissions (644 for most files, 640 for sensitive files)
          find . -type f -exec chmod 644 {} +
          
          # More restrictive permissions for sensitive files
          find . -name 'composer.json' -exec chmod 640 {} +
          find . -name 'composer.lock' -exec chmod 640 {} +
          find . -name '*.php' -path './config/*' -exec chmod 640 {} +
          
          # Make sure the main plugin file is readable
          chmod 644 "${PLUGIN_NAME}.php"
          
          echo 'File permissions set correctly'
EOF
        
        echo "::endgroup::"

  # Post-deployment verification
  verify:
    name: Post-deployment Verification
    runs-on: ubuntu-latest
    needs: [validate, backup, deploy]
    if: needs.validate.outputs.should_deploy == 'true'

    steps:
    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

    - name: Add known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H -p ${{ env.SSH_PORT }} ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

    - name: Verify deployment
      run: |
        echo "::group::Verifying deployment"
        
        export DEPLOY_USER="${{ secrets.DEPLOY_USER }}"
        export DEPLOY_HOST="${{ secrets.DEPLOY_HOST }}"
        export SSH_PORT="${{ env.SSH_PORT }}"
        export DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
        export PLUGIN_NAME="${{ env.PLUGIN_NAME }}"
        
        # Check if main plugin file exists
        ssh -p "${SSH_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" 'bash -s' << 'EOF'
          set -e
          if [[ -f "${DEPLOY_PATH}/${PLUGIN_NAME}.php" ]]; then
            echo '‚úÖ Main plugin file exists'
          else
            echo '‚ùå Main plugin file missing'
            exit 1
          fi
          
          # Check directory structure
          required_dirs=('vendor')
          for dir in "${required_dirs[@]}"; do
            if [[ -d "${DEPLOY_PATH}/${dir}" ]]; then
              echo "‚úÖ Directory exists: ${dir}"
            else
              echo "‚ùå Directory missing: ${dir}"
              exit 1
            fi
          done
          
          # Check optional directories
          optional_dirs=('tests' 'config' 'src')
          for dir in "${optional_dirs[@]}"; do
            if [[ -d "${DEPLOY_PATH}/${dir}" ]]; then
              echo "‚úÖ Optional directory exists: ${dir}"
            else
              echo "‚ÑπÔ∏è Optional directory not present: ${dir}"
            fi
          done
          
          # Check PHP syntax on server
          php -l "${DEPLOY_PATH}/${PLUGIN_NAME}.php" || exit 1
          echo '‚úÖ PHP syntax check passed on server'
          
          # Check file sizes (basic integrity check)
          main_size=$(stat -c%s "${DEPLOY_PATH}/${PLUGIN_NAME}.php")
          if [[ ${main_size} -lt 1000 ]]; then
            echo '‚ùå Main plugin file seems too small'
            exit 1
          fi
          echo "‚úÖ Main plugin file size: ${main_size} bytes"
          
          # Verify deployment hash if available
          if [[ -f "${DEPLOY_PATH}/DEPLOYMENT_INFO.txt" ]]; then
            echo '‚úÖ Deployment info file found'
            cat "${DEPLOY_PATH}/DEPLOYMENT_INFO.txt"
          fi
EOF
        
        echo "::endgroup::"

    - name: Test basic plugin functionality
      run: |
        echo "::group::Testing basic functionality"
        
        export DEPLOY_USER="${{ secrets.DEPLOY_USER }}"
        export DEPLOY_HOST="${{ secrets.DEPLOY_HOST }}"
        export SSH_PORT="${{ env.SSH_PORT }}"
        export DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
        export PLUGIN_NAME="${{ env.PLUGIN_NAME }}"
        
        # Test that the plugin file can be included without errors
        ssh -p "${SSH_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" 'bash -s' << 'EOF'
          set -e
          cd "${DEPLOY_PATH}"
          php -r "include '${PLUGIN_NAME}.php'; echo 'Plugin loaded successfully\n';" || {
            echo '‚ùå Plugin failed to load'
            exit 1
          }
          echo '‚úÖ Plugin loads without errors'
EOF
        
        echo "::endgroup::"

    - name: Health check endpoint test
      if: vars.HEALTH_CHECK_URL
      run: |
        echo "::group::Testing health check endpoint"
        
        # Wait a moment for changes to propagate
        sleep 10
        
        response=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.HEALTH_CHECK_URL }}" || echo "000")
        
        if [[ "$response" == "200" ]]; then
          echo "‚úÖ Health check passed (HTTP $response)"
        else
          echo "‚ùå Health check failed (HTTP $response)"
          echo "::error::Health check failed with HTTP $response. Deployment will be rolled back."
          exit 1
        fi
        
        echo "::endgroup::"

  # Rollback job (only runs on failure)
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [validate, backup, deploy, verify]
    if: failure() && needs.backup.result == 'success' && github.event.inputs.skip_backup != 'true'

    steps:
    - name: Setup SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

    - name: Add known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H -p ${{ env.SSH_PORT }} ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

    - name: Rollback to previous version
      run: |
        echo "::group::Rolling back deployment"
        
        export DEPLOY_USER="${{ secrets.DEPLOY_USER }}"
        export DEPLOY_HOST="${{ secrets.DEPLOY_HOST }}"
        export SSH_PORT="${{ env.SSH_PORT }}"
        export DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
        export BACKUP_PATH="${{ env.BACKUP_PATH }}"
        export BACKUP_NAME="${{ needs.validate.outputs.backup_name }}"
        
        ssh -p "${SSH_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" 'bash -s' << 'EOF'
          set -e
          backup_path="${BACKUP_PATH}/${BACKUP_NAME}"
          
          if [[ -d "${backup_path}" ]]; then
            echo "Rolling back to backup: ${BACKUP_NAME}"
            
            # Remove failed deployment
            rm -rf "${DEPLOY_PATH}"
            
            # Restore from backup
            cp -r "${backup_path}" "${DEPLOY_PATH}"
            
            # Add rollback marker
            {
              echo 'ROLLBACK PERFORMED'
              echo "Original commit: ${{ github.sha }}"
              echo "Rollback time: $(date -u)"
            } >> "${DEPLOY_PATH}/ROLLBACK_INFO.txt"
            
            echo '‚úÖ Rollback completed successfully'
          else
            echo '‚ö†Ô∏è No backup found, manual intervention required'
            exit 1
          fi
EOF
        
        echo "::endgroup::"

    - name: Verify rollback
      run: |
        export DEPLOY_USER="${{ secrets.DEPLOY_USER }}"
        export DEPLOY_HOST="${{ secrets.DEPLOY_HOST }}"
        export SSH_PORT="${{ env.SSH_PORT }}"
        export DEPLOY_PATH="${{ env.DEPLOY_PATH }}"
        export PLUGIN_NAME="${{ env.PLUGIN_NAME }}"
        
        ssh -p "${SSH_PORT}" "${DEPLOY_USER}@${DEPLOY_HOST}" 'bash -s' << 'EOF'
          set -e
          if [[ -f "${DEPLOY_PATH}/${PLUGIN_NAME}.php" ]]; then
            echo "‚úÖ Main plugin file exists after rollback"
            # Additional verification
            php -l "${DEPLOY_PATH}/${PLUGIN_NAME}.php" || exit 1
            echo "‚úÖ PHP syntax check passed after rollback"
            
            # Check critical directories
            if [[ -d "${DEPLOY_PATH}/vendor" ]]; then
              echo "‚úÖ Vendor directory restored"
            fi
            
            echo "‚úÖ Rollback verification completed successfully"
          else
            echo "‚ùå Rollback verification failed - main plugin file missing"
            exit 1
          fi
EOF

  # Notification job
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [validate, backup, deploy, verify, rollback]
    if: always() && needs.validate.outputs.should_deploy == 'true'

    steps:
    - name: Determine deployment status
      id: status
      run: |
        if [[ "${{ needs.verify.result }}" == "success" ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=‚úÖ Deployment completed successfully" >> $GITHUB_OUTPUT
          echo "color=good" >> $GITHUB_OUTPUT
        elif [[ "${{ needs.rollback.result }}" == "success" ]]; then
          echo "status=rolled_back" >> $GITHUB_OUTPUT
          echo "message=‚ö†Ô∏è Deployment failed and was rolled back" >> $GITHUB_OUTPUT
          echo "color=warning" >> $GITHUB_OUTPUT
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "message=‚ùå Deployment failed" >> $GITHUB_OUTPUT
          echo "color=danger" >> $GITHUB_OUTPUT
        fi

    - name: Send Slack notification
      if: vars.SLACK_WEBHOOK_URL
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "text": "${{ steps.status.outputs.message }}",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*84em Local Pages Plugin Deployment*\n${{ steps.status.outputs.message }}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\n${{ github.event.inputs.environment || 'production' }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Commit:*\n<https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n${{ github.ref_name }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Triggered by:*\n${{ github.actor }}"
                  }
                ]
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": "View Workflow"
                    },
                    "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ vars.SLACK_WEBHOOK_URL }}

    - name: Send email notification
      if: vars.NOTIFICATION_EMAIL && steps.status.outputs.status != 'success'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT || 587 }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "84em Local Pages Deployment ${{ steps.status.outputs.status }}"
        to: ${{ vars.NOTIFICATION_EMAIL }}
        from: "GitHub Actions <noreply@github.com>"
        body: |
          Deployment Status: ${{ steps.status.outputs.message }}
          
          Environment: ${{ github.event.inputs.environment || 'production' }}
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Triggered by: ${{ github.actor }}
          
          View full workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    - name: Create deployment summary
      run: |
        echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Status | ${{ steps.status.outputs.message }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | ${{ github.event.inputs.environment || 'production' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Commit | [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
        echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Deploy Hash | \`${{ needs.validate.outputs.deploy_hash }}\` |" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ needs.backup.result }}" == "success" ]]; then
          echo "| Backup created | ${{ needs.validate.outputs.backup_name }} |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Target path:** \`${{ env.DEPLOY_PATH }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Backup path:** \`${{ env.BACKUP_PATH }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **SSH Port:** ${{ env.SSH_PORT }}" >> $GITHUB_STEP_SUMMARY
        echo "- **PHP version:** ${{ env.PHP_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Job Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Validation:** ${{ needs.validate.result }} ‚úÖ" >> $GITHUB_STEP_SUMMARY
        echo "- **Backup:** ${{ needs.backup.result || 'skipped' }} ${{ needs.backup.result == 'success' && '‚úÖ' || needs.backup.result == 'failure' && '‚ùå' || '‚è≠Ô∏è' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deploy:** ${{ needs.deploy.result }} ${{ needs.deploy.result == 'success' && '‚úÖ' || '‚ùå' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Verify:** ${{ needs.verify.result }} ${{ needs.verify.result == 'success' && '‚úÖ' || '‚ùå' }}" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ needs.rollback.result }}" != "" ]]; then
          echo "- **Rollback:** ${{ needs.rollback.result }} ${{ needs.rollback.result == 'success' && '‚úÖ' || '‚ùå' }}" >> $GITHUB_STEP_SUMMARY
        fi
