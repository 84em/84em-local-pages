name: WP-CLI Tests

on:
  push:
    branches: [ main, dev, develop, 'feature/**' ]
  pull_request:
    branches: [ main, dev, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    name: WP-CLI Tests on PHP 8.2
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, intl, mysql, openssl
        tools: composer:v2, wp-cli
    
    - name: Install Composer dependencies
      run: composer install --prefer-dist --no-progress --no-interaction
    
    - name: Setup WordPress
      run: |
        # Download WordPress
        wp core download --path=/tmp/wordpress --force
        
        # Create wp-config.php
        wp config create --path=/tmp/wordpress \
          --dbname=wordpress_test \
          --dbuser=root \
          --dbpass=root \
          --dbhost=127.0.0.1 \
          --skip-check
        
        # Create database
        wp db create --path=/tmp/wordpress || true
        
        # Install WordPress
        wp core install --path=/tmp/wordpress \
          --url=http://localhost \
          --title="Test Site" \
          --admin_user=admin \
          --admin_password=password \
          --admin_email=admin@example.com \
          --skip-email
        
        # Copy plugin to WordPress plugins directory
        cp -r . /tmp/wordpress/wp-content/plugins/84em-local-pages
        
        # Activate plugin
        wp plugin activate 84em-local-pages --path=/tmp/wordpress
    
    - name: Run WP-CLI Tests
      run: |
        cd /tmp/wordpress
        wp 84em local-pages --test --all
      env:
        MYSQL_HOST: 127.0.0.1
        MYSQL_USER: root
        MYSQL_PASSWORD: root
        MYSQL_DATABASE: wordpress_test
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3